{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">ðŸ“Š Tablero de Control</h2>

  {% if es_admin %}
    <div class="mb-3 text-end">
      <a href="{% url 'exportar_excel' %}" class="btn btn-outline-success btn-sm me-2">
        ðŸ“¥ Exportar a Excel
      </a>
      <a href="{% url 'exportar_pdf' %}" class="btn btn-outline-danger btn-sm">
        ðŸ§¾ Exportar a PDF
      </a>
    </div>
  {% endif %}

  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead class="table-primary">
        <tr>
          <th style="width: 40px;">NÂ°</th>
          <th>Eje EstratÃ©gico</th>
          <th>Objetivo EstratÃ©gico</th>
          <th>Indicador</th>
          <th>Meta 2025</th>
          <th>Avance</th>
          <th>Nivel</th>
          <th>AcciÃ³n</th>
          <th>Responsable</th>
          <th>ObservaciÃ³n</th>
          <th>Editar</th>
          {% if es_admin %}
            <th>Historial</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for eje, objetivos in agrupado.items %}
          {% with contador=forloop.counter %}
            {% for objetivo, items in objetivos.items %}
              {% for item in items %}
              <tr>
                {% if forloop.first %}
                  <td rowspan="{{ items|length }}">{{ forloop.parentloop.parentloop.counter }}</td>
                  <td rowspan="{{ items|length }}"><strong>{{ eje }}</strong></td>
                  <td rowspan="{{ items|length }}" class="fw-bold bg-light">{{ objetivo }}</td>
                {% endif %}
                <td>{{ forloop.counter }}. {{ item.indicador|default_if_none:'' }}</td>
                <td>{{ item.meta_2025|default_if_none:"" }}</td>
                <td>{{ item.avance|default_if_none:"" }}</td>
                <td>
                  {% if item.nivel == "Bajo" %}
                    <span class="badge bg-danger">Bajo</span>
                  {% elif item.nivel == "Medio" %}
                    <span class="badge bg-warning text-dark">Medio</span>
                  {% elif item.nivel == "Alto" %}
                    <span class="badge bg-success">Alto</span>
                  {% else %}
                    <!-- vacÃ­o -->
                  {% endif %}
                </td>
                <td>{{ item.accion|default_if_none:"" }}</td>
                <td>{{ item.responsable|default_if_none:"" }}</td>
                <td>{{ item.observacion|default_if_none:"" }}</td>
                <td>
                  <a href="{% url 'editar_avance' item.id %}" class="btn btn-sm btn-outline-primary">Editar</a>
                </td>
                {% if es_admin %}
                <td>
                  <a href="{% url 'ver_historial' item.id %}" class="btn btn-sm btn-outline-secondary">Historial</a>
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            {% endfor %}
          {% endwith %}
        {% empty %}
          <tr>
            <td colspan="12">No hay datos disponibles.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
